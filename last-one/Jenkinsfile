pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'bilel06/last-one'
        DOCKER_CREDENTIALS_ID = 'dockerhub-creds'
        GIT_USER = 'Bilel-lefi'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/Bilel-lefi/-test-123.git'
            }
        }

        stage('Build and Tag Docker Image') {
            steps {
                script {
                    def image = docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                    docker.withRegistry('https://index.docker.io/v1/', "${DOCKER_CREDENTIALS_ID}") {
                        image.push()
                    }
                }
            }
        }

        stage('Update Manifest') {
            steps {
                bat '''
                    powershell -Command ^
                    "$ts = Get-Date -Format 'yyyy-MM-ddTHH:mm:ss'; ^
                    (Get-Content 'argocd\\manifests\\deployment.yaml') -replace 'redeploy-timestamp: \\".*\\"', 'redeploy-timestamp: \\'$ts\\'' -replace 'image: bilel06/last-one:.*', 'image: bilel06/last-one:${BUILD_NUMBER}' | Set-Content 'argocd\\manifests\\deployment.yaml'"
                '''
            }
        }

        // Décommente cette étape si tu veux automatiser le commit/push du manifest
        // stage('Commit and Push Manifest') {
        //     steps {
        //         withCredentials([string(credentialsId: 'github-pat-token', variable: 'GITHUB_TOKEN')]) {
        //             bat '''
        //                 git config user.email "bilellefi06@gmail.com"
        //                 git config user.name "bilel"
        //                 git add argocd\\manifests\\deployment.yaml
        //                 git commit -m "Update image tag and redeploy timestamp"
        //                 git push https://%GIT_USER%:%GITHUB_TOKEN%@github.com/Bilel-lefi/-test-123.git master
        //             '''
        //         }
        //     }
        // }
    }
}
